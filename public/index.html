<!DOCTYPE html>
<html ng-app="cryptoApp">

<head>
  <meta charset="UTF-8">
  <title>Chain Pay</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
  <style>
    body {
      background: linear-gradient(135deg, #ff6ec4, #7873f5);
      color: #fff;
      font-family: 'Helvetica Neue', sans-serif;
      margin: 0;
      padding: 0;
    }

    .main-container {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }

    .transfer-card {
      background: rgba(0, 0, 0, 0.5);
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
      width: 100%;
      max-width: 400px;
      position: relative;
    }

    .form-control {
      background-color: #333;
      color: #fff;
      border: 1px solid #777;
    }

    .btn-funky {
      background-color: #ff6ec4;
      border: none;
      color: white;
      font-weight: bold;
    }

    .btn-funky:hover {
      background-color: #ff3ca1;
    }

    h2 {
      text-align: center;
      margin-bottom: 20px;
      color: #ffffff;
    }

    .crypto-option {
      display: flex;
      align-items: center;
    }

    .crypto-option img {
      height: 20px;
      width: 20px;
      margin-right: 8px;
    }

    option {
      color: #000;
    }

    .wallet-address {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
    }

    .wallet-address .btn-connect {
      background-color: #ff6ec4;
      border: none;
      color: white;
      font-weight: bold;
      border-radius: 8px;
      padding: 10px;
    }

    .wallet-address .btn-connect:hover {
      background-color: #ff3ca1;
    }

    .status-row {
      text-align: center;
      margin-top: 15px;
    }

    .status-message-failure {
      background: rgba(235, 7, 7, 0.926);
      color: white;
      padding: 10px 15px;
      border-radius: 8px;
      display: inline-block;
    }

    .status-message-success {
      background: rgba(91, 243, 4, 0.926);
      color: white;
      padding: 10px 15px;
      border-radius: 8px;
      display: inline-block;
    }

    .spinner-img {
      width: 40px;
      height: 40px;
      margin-top: 15px;
    }

    .description-row {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.4s ease-out, padding 0.4s ease-out;
    }

    .description-row.show {
      max-height: 500px;
      /* enough for a few lines of text */
      padding-top: 15px;
    }

    .settings-link {
    position: fixed;
    bottom: 20px;
    right: 20px;
    text-decoration: none;
    color: #666;
    font-size: 14px;
    background-color: #f8f9fa;
    padding: 6px 12px;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    z-index: 999;
  }

  .settings-link:hover {
    background-color: #ff6ec4;
    color: #000;
  }

  .modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: #796d74;
  z-index: 1050;
  display: flex;
  justify-content: center;
  align-items: center;
}

.modal-content {
  background: #ff6ec4;
  padding: 20px;
  width: 300px;
  border-radius: 8px;
}


  

  </style>
</head>

<body ng-controller="TransferController as ctrl">

  <div class="wallet-address">
    <button class="btn btn-connect" ng-click="ctrl.connectWallet()">
      {{ ctrl.walletAddress ? ('Connected: ' + ctrl.walletAddress.slice(0, 6) + '...' + ctrl.walletAddress.slice(-4)) :
      'Connect Wallet' }}
    </button>
  </div>

  <div class="main-container">

    <div class="transfer-card">
      <h2 ng-style="{ color: ctrl.settings.themeColor }">{{ctrl.settings.appname}}</h2>
      <form name="transferForm" ng-submit="ctrl.transfer()">
        <div class="form-group">
          <label for="to">To Address</label>
          <input type="text" id="to" class="form-control" ng-model="ctrl.form.to" required>
        </div>

        <div class="form-group">
          <label for="currency">Currency</label>
          <select class="form-control" id="currency" ng-model="ctrl.form.currency"
            ng-options="token.symbol as token.name for token in ctrl.tokens" required>
            <option value="" disabled selected>Select token</option>
          </select>
        </div>

        <div class="form-group">
          <label for="amount">Amount</label>
          <input type="number" id="amount" class="form-control" ng-model="ctrl.form.amount" min="0.001" step="0.001"
            required>
        </div>

        <button type="submit" class="btn btn-funky btn-block"
          ng-disabled="transferForm.$invalid || !ctrl.walletAddress || ctrl.loading">
          {{ ctrl.loading ? 'Sending...' : 'Send' }}
        </button>
      </form>

      <div class="status-row" ng-if="ctrl.loading">
        <img class="spinner-img" src="https://i.gifer.com/ZZ5H.gif" alt="Loading...">
      </div>

      <div class="status-row" ng-if="ctrl.successMsg && ctrl.showMessage">
        <!-- <p class="status-message-success">{{ctrl.successMsg}}</p> -->
        <p ng-class="ctrl.highestSeverityNotNull ? 'status-message-failure' : 'status-message-success'">{{ctrl.successMsg}}</p>
      </div>

      <div ng-if="ctrl.highestSeverityNotNull">
        <label>
          <input type="checkbox" ng-click="ctrl.showEventDescription()"> Show Details
        </label>
      </div>
    </div>
  </div>

  <div class="status-row description-row" ng-if="ctrl.displayEventDescription">
    <div class="status-message">
      {{ ctrl.eventDescription }}
    </div>
  </div>

  <a href="#" class="settings-link"  ng-click="ctrl.showSettings = true">
    ⚙️ 
  </a>

  <div class="modal-overlay" ng-if="ctrl.showSettings">
    <div class="modal-content">
      <h4>Settings</h4>
      <form>
        <div class="form-group">
          <label for="setting1">Gate Signer Id</label>
          <input type="text" id="gate-signer-id" class="form-control" ng-model="ctrl.settings.signerid">
        </div>
  
        <div class="form-group">
          <label for="setting2">App Name</label>
          <input type="text" id="setting2" class="form-control" ng-model="ctrl.settings.appname">
        </div>

        <div class="form-group">
          <label for="themeColor">Theme Color</label>
          <input type="color" id="themeColor" class="form-control form-control-color" ng-model="ctrl.settings.themeColor">
        </div>
  
        <button type="button" class="btn btn-success" ng-click="ctrl.saveSettings()">Save</button>
        <button type="button" class="btn btn-danger" ng-click="ctrl.showSettings = false">Close</button>
      </form>
    </div>
  </div>
  

  

  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.9/angular.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.10.0/dist/ethers.umd.min.js"></script>

  <script>
    angular.module('cryptoApp', [])
      .controller('TransferController', function ($timeout, $http, $scope) {
        var vm = this;
        const { ethers } = window.ethers;
        vm.ethers = ethers;

        vm.showSettings  = false;
        vm.settings =  {
          signerid: 75,
          appname: 'Chain Pay',
          themeColor: '#ef5e15'
        }

        vm.saveSettings = function () {
          console.log('Settings saved:', this.settings);
          vm.showSettings = false; // Close modal
        }

        vm.tokens = [
          { symbol: 'ETH', name: 'Ethereum' },
          { symbol: 'USDT', name: 'Tether (USDT)' },
          { symbol: 'USDC', name: 'USD Coin (USDC)' }
        ];

        vm.form = {
          from: '',
          to: '',
          currency: '',
          amount: ''
        };

        vm.walletAddress = '';
        vm.successMsg = '';
        vm.success = false;
        vm.loading = false;
        vm.showMessage = false;

        vm.shortenAddress = function(address, start = 6, end = 4) {
          if (!address || address.length < start + end + 2) return address;
          return `${address.slice(0, start)}...${address.slice(-end)}`;
        }

        vm.connectWallet = async function () {
          if (typeof window.ethereum !== 'undefined') {
            try {
              const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
              vm.walletAddress = accounts[0];
              $scope.$apply();
            } catch (err) {
              alert('Wallet connection failed.');
            }
          } else {
            alert('MetaMask is not installed.');
          }
        };

        vm.popupWallet = async function (payload) {
          // const amount = '0'; // Reset USDT spend
          var contractAddress = '0xdAC17F958D2ee523a2206206994597C13D831ec7';  // Tether contract address
          var abi = JSON.parse('[{"constant":true,"inputs":[],"name":"name","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_spender","type":"address"},{"name":"_value","type":"uint256"}],"name":"approve","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"totalSupply","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_from","type":"address"},{"name":"_to","type":"address"},{"name":"_value","type":"uint256"}],"name":"transferFrom","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"decimals","outputs":[{"name":"","type":"uint8"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"_owner","type":"address"}],"name":"balanceOf","outputs":[{"name":"balance","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"symbol","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_to","type":"address"},{"name":"_value","type":"uint256"}],"name":"transfer","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"_owner","type":"address"},{"name":"_spender","type":"address"}],"name":"allowance","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"payable":true,"stateMutability":"payable","type":"fallback"},{"anonymous":false,"inputs":[{"indexed":true,"name":"owner","type":"address"},{"indexed":true,"name":"spender","type":"address"},{"indexed":false,"name":"value","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"from","type":"address"},{"indexed":true,"name":"to","type":"address"},{"indexed":false,"name":"value","type":"uint256"}],"name":"Transfer","type":"event"}]');

          var erc20Contract = new web3.eth.Contract(abi, contractAddress);
          // Convert 50 USDT (6 decimals)
          const amount = vm.ethers.parseUnits(payload.amount.toString(), 6);
          console.log("USDT raw amount:", amount);
          var functionData = erc20Contract.methods.transfer(payload.to, amount).encodeABI()

          // Set the gas price in gwei (1 gwei = 1e9 wei)
          const gasPriceInGwei = '20';
          // Convert gas price to wei (1 gwei = 1e9 wei)
          const gasPriceInWei = web3.utils.toWei(gasPriceInGwei, 'gwei');
          await window.ethereum.request({
            "method": "eth_sendTransaction",
            "params": [
              {
                "to": contractAddress,
                "from": payload.from,
                "data": functionData,
              }
            ]
          });
        }

        vm.showEventDescription = function () {
          vm.displayEventDescription = true;
          $scope.$applyAsync();
        };

        vm.transfer = async function () {
          if (window.ethereum) {
            window.web3 = new Web3(ethereum);
            ethereum.enable().catch(() => {
              console.warn("User didn't allow access to accounts.");
            });
          } else {
            alert("Non-Ethereum enabled browser detected. You should consider installing MetaMask.");
            return;
          }

          vm.loading = true;
          vm.showMessage = false;
          vm.displayEventDescription = false;
          vm.highestSeverityNotNull = false;

          let payload = {
            from: vm.walletAddress,
            to: vm.form.to,
            currency: vm.form.currency,
            amount: vm.form.amount
          };

          $http.post('/gate-signer-check', payload, {
            headers: {
              'Content-Type': 'application/json',
            }
          }).then(function (response) {
            console.log('Success:', response.data);

            const highestSeverity = response.data?.result?.highest_severity;
            const firstEventDescription = response.data?.result?.events?.[0]?.description;

            if (highestSeverity === null) {
              vm.success = true;
              vm.showMessage = true;
              vm.successMsg = "Transfer of " + vm.form.amount + " " + vm.form.currency + " to " + vm.shortenAddress(vm.form.to) + " has passed the Hexagate GateSigner Validation.";
              vm.popupWallet(payload);
              vm.highestSeverityNotNull = false;
            } else {
              vm.showMessage = true;
              vm.successMsg = "Transfer of " + vm.form.amount + " " + vm.form.currency + " to " + vm.shortenAddress(vm.form.to) + " has failed the Hexagate GateSigner Validation.";
              vm.highestSeverityNotNull = true;
              vm.eventDescription = firstEventDescription;
            }

          }).catch(function (error) {
            console.error('Error:', error.data || error);
          }).finally(function () {
            vm.loading = false;
            $scope.$applyAsync();
          });
        };
      });
  </script>
</body>

</html>